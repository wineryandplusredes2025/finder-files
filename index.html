<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Buscador de PDFs</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      :root{
        --bg:#ffffff; --fg:#111111; --muted:#666666; --card:#f8f8f8; --toggle-bg:#ddd; --knob-bg:#ffffff;
      }
      .dark{
        --bg:#0f1720; --fg:#e6eef6; --muted:#9fb0c3; --card:#12202a; --toggle-bg:#3b82f6; --knob-bg:#ffffff;
      }
      html,body{height:100%}
      body { font-family: Arial, Helvetica, sans-serif; padding: 20px; background:var(--bg); color:var(--fg); }
      input, button { font-family: inherit }
      #search { width: 60%; padding: 8px; margin-bottom: 12px; border:1px solid #ccc; border-radius:4px }
      .file-item { padding: 8px 0; display:flex;align-items:center;justify-content:space-between;background:transparent }
      .file-item span { flex:1 }
      .no-results { color: var(--muted) }
      #download-zip { margin-left: 12px }
      #status { color: var(--muted) }
      /* slider visual tweaks */
      #slider { background:var(--toggle-bg) }
      .dark #slider { background:var(--toggle-bg) }
      .dark #knob { background:var(--knob-bg) }
    </style>
  </head>
  <body>
    <h1>Buscador de PDFs</h1>
    <div style="display:flex;align-items:center;gap:12px;">
      <input id="search" placeholder="Buscar..." />
      <button id="download-zip">Descargar ZIP completo</button>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;">
        <span id="theme-label">Claro</span>
        <div id="theme-toggle" style="width:44px;height:24px;position:relative;">
          <input type="checkbox" id="theme-checkbox" style="opacity:0;position:absolute;width:1px;height:1px;left:-9999px;" />
          <div id="slider" style="width:44px;height:24px;border-radius:999px;background:var(--toggle-bg);position:relative;transition:background .2s;"></div>
          <div id="knob" style="width:18px;height:18px;border-radius:50%;background:var(--knob-bg);position:absolute;top:3px;left:3px;transition:left .2s,background .2s;box-shadow:0 1px 3px rgba(0,0,0,.3);"></div>
        </div>
      </label>
    </div>
    <div id="status" style="margin-top:8px;color:#333"></div>
    <div id="file-list"></div>

    <script>
    // Cargar lista de PDFs desde pdfs/names.txt para mantener sincronización con la carpeta
    let pdfFiles = [];
    const folderPath = './pdfs/';
    const logoUrl = './logo.png';
    const fileListElement = document.getElementById('file-list');
    const searchInput = document.getElementById('search');

    // Mostrar mensajes simples en la UI
    function setStatus(msg) {
      const el = document.getElementById('status');
      if (el) el.textContent = msg;
      else console.log('STATUS: ' + msg);
    }

    const logo2Files = [
      'TEHUACAN BRILLANTE LATA SLEEK.pdf',
      'TEHUACAN BRILLANTE NARANJADA.pdf',
      'TEHUACAN BRILLANTE LIMONADA.pdf',
      'Tehuacan Brillante.pdf',
      'Agua de Piedra.pdf'
    ];

    async function loadPdfList() {
      try {
        setStatus('Cargando lista de PDFs...');
        const res = await fetch('./pdfs/names.txt');
        if (!res.ok) throw new Error('No se pudo cargar la lista de PDFs');
        const text = await res.text();
        // dividir por líneas y filtrar vacías
        pdfFiles = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        renderFiles(pdfFiles);
        setStatus('Lista cargada (' + pdfFiles.length + ' archivos)');
      } catch (err) {
        console.warn('Fallo al cargar names.txt, usando lista embebida mínima. ' + err.message);
        // Fallback a la lista anterior mínima si existe un fallo
        pdfFiles = ['Agua de Piedra.pdf', 'MONTEVIEJO La Violeta Malbec.pdf'];
        renderFiles(pdfFiles);
        setStatus('Usando fallback: names.txt no disponible');
      }
    }

    function renderFiles(filteredFiles) {
      fileListElement.innerHTML = '';
      if (!filteredFiles || filteredFiles.length === 0) {
        fileListElement.innerHTML = '<div class="no-results">No se encontraron resultados.</div>';
        return;
      }
      filteredFiles.forEach(file => {
        const div = document.createElement('div');
        div.className = 'file-item';
        const fileTitle = document.createElement('span');
        fileTitle.textContent = file;
        fileTitle.style.fontWeight = '500';
        const logoBtn = document.createElement('button');
        logoBtn.textContent = logo2Files.includes(file) ? 'Descargar Pdf' : 'Descargar con restricciones de alcohol';
        logoBtn.onclick = () => {
          const logoToUse = logo2Files.includes(file) ? './logo2.png' : logoUrl;
          addLogoToPdf(folderPath + file, file, logoToUse);
        };
        div.appendChild(fileTitle);
        div.appendChild(logoBtn);
        fileListElement.appendChild(div);
      });
    }

    function filterFiles(query) {
      const filtered = pdfFiles.filter(file =>
        file.toLowerCase().includes(query.toLowerCase())
      );
      renderFiles(filtered);
    }

    searchInput.addEventListener('input', e => {
      filterFiles(e.target.value);
    });

    // Función para agregar logo a un PDF
    async function addLogoToPdf(pdfUrl, fileName, logoPath = logoUrl) {
      try {
        setStatus('Procesando ' + fileName + '...');
    const existingPdfBytes = await fetch(folderPath + encodeURIComponent(fileName)).then(res => res.arrayBuffer());
        const pngImageBytes = await fetch(logoPath).then(res => res.arrayBuffer());
        const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
        const pngImage = await pdfDoc.embedPng(pngImageBytes);
        const pages = pdfDoc.getPages();
        for (const page of pages) {
          const { width } = page.getSize();
          const logoWidth = width - 60; // margen lateral
          const originalWidth = 2315.4268;
          const originalHeight = 90.8682;
          const logoHeight = (logoWidth / originalWidth) * originalHeight;
          page.drawImage(pngImage, {
            x: 30,
            y: 10,
            width: logoWidth,
            height: logoHeight,
          });
        }
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        setStatus('Descarga completada: ' + fileName);
      } catch (error) {
        console.error(error);
        setStatus('Error al procesar ' + fileName + ': ' + error.message);
        alert('Error al agregar el logo: ' + error.message);
      }
    }

    // Descargar todos los PDFs en un ZIP (inserta logo correspondiente por archivo)
    async function downloadCompleteZip() {
      const downloadBtn = document.getElementById('download-zip');
      downloadBtn.disabled = true;
      setStatus('Creando ZIP con ' + pdfFiles.length + ' archivos... (esto puede tardar)');
      const filesToZip = Array.from(pdfFiles); // todos los archivos
      const zip = new JSZip();
      // Procesar cada PDF y agregarlo al ZIP
      for (const file of filesToZip) {
        try {
          setStatus('Procesando: ' + file + ' (' + (filesToZip.indexOf(file) + 1) + '/' + filesToZip.length + ')');
            const existingPdfBytes = await fetch(folderPath + encodeURIComponent(file)).then(res => res.arrayBuffer());
          // elegir logo según el archivo
          const logoPath = logo2Files.includes(file) ? './logo2.png' : logoUrl;
          const pngImageBytes = await fetch(logoPath).then(res => res.arrayBuffer());
          const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
          const pngImage = await pdfDoc.embedPng(pngImageBytes);
          const pages = pdfDoc.getPages();
          for (const page of pages) {
            const { width } = page.getSize();
            const logoWidth = width - 60;
            const originalWidth = 2315.4268;
            const originalHeight = 90.8682;
            const logoHeight = (logoWidth / originalWidth) * originalHeight;
            page.drawImage(pngImage, {
              x: 30,
              y: 10,
              width: logoWidth,
              height: logoHeight,
            });
          }
          const pdfBytes = await pdfDoc.save();
          zip.file(file, pdfBytes);
        } catch (error) {
          console.warn('Error procesando ' + file + ': ' + error.message);
          console.error(error);
        }
      }
      // Generar y descargar el ZIP
      zip.generateAsync({ type: 'blob' }).then(function(content) {
        const zipName = 'PDFs_completos.zip';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = zipName;
        a.click();
        setStatus('ZIP creado: ' + zipName);
        downloadBtn.disabled = false;
      }).catch(err => {
        console.error(err);
        setStatus('Error al generar ZIP: ' + err.message);
        downloadBtn.disabled = false;
      });
    }

    // Función previa que generaba ZIP excluyendo archivos con logo2 (la dejamos disponible si se necesita)
    async function downloadAlcoholRestrictedZip() {
      const filesToZip = pdfFiles.filter(file => !logo2Files.includes(file));
      const zip = new JSZip();
      const logoPath = logoUrl;
      for (const file of filesToZip) {
        try {
            const existingPdfBytes = await fetch(folderPath + encodeURIComponent(file)).then(res => res.arrayBuffer());
          const pngImageBytes = await fetch(logoPath).then(res => res.arrayBuffer());
          const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
          const pngImage = await pdfDoc.embedPng(pngImageBytes);
          const pages = pdfDoc.getPages();
          for (const page of pages) {
            const { width } = page.getSize();
            const logoWidth = width - 60;
            const originalWidth = 2315.4268;
            const originalHeight = 90.8682;
            const logoHeight = (logoWidth / originalWidth) * originalHeight;
            page.drawImage(pngImage, {
              x: 30,
              y: 10,
              width: logoWidth,
              height: logoHeight,
            });
          }
          const pdfBytes = await pdfDoc.save();
          zip.file(file, pdfBytes);
        } catch (error) {
          console.warn('Error procesando ' + file + ': ' + error.message);
        }
      }
      zip.generateAsync({ type: 'blob' }).then(function(content) {
        const zipName = 'PDFs_con_restricciones_de_alcohol.zip';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = zipName;
        a.click();
      });
    }

  // Inicializar
  // Tema: aplicar preferencia guardada
  (function(){
    const stored = localStorage.getItem('site-theme');
    if(stored === 'dark') document.documentElement.classList.add('dark');
  })();

  function updateThemeUI(){
    const isDark = document.documentElement.classList.contains('dark');
    const checkbox = document.getElementById('theme-checkbox');
    const label = document.getElementById('theme-label');
    const knob = document.getElementById('knob');
    if(checkbox) checkbox.checked = !!isDark;
    if(label) label.textContent = isDark ? 'Oscuro' : 'Claro';
    if(knob) knob.style.left = isDark ? '23px' : '3px';
  }

  // Conectar toggle
  const toggleEl = document.getElementById('theme-toggle');
  if(toggleEl) toggleEl.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('site-theme', isDark ? 'dark' : 'light');
    updateThemeUI();
  });

  updateThemeUI();

  loadPdfList();
  // El botón ahora descarga el ZIP completo
  document.getElementById('download-zip').addEventListener('click', downloadCompleteZip);
    </script>
  </body>
</html>