<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Buscador de PDFs</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      body { font-family: Arial, Helvetica, sans-serif; padding: 20px; }
      #search { width: 60%; padding: 8px; margin-bottom: 12px }
      .file-item { padding: 8px 0; display:flex; align-items:center; justify-content:space-between }
      .file-item span { flex:1 }
      .no-results { color: #666 }
      #download-zip { margin-left: 12px }
    </style>
  </head>
  <body>
    <h1>Buscador de PDFs</h1>
    <div>
      <input id="search" placeholder="Buscar..." />
      <button id="download-zip">Descargar ZIP completo</button>
    </div>
    <div id="file-list"></div>

    <script>
    // Cargar lista de PDFs desde pdfs/names.txt para mantener sincronización con la carpeta
    let pdfFiles = [];
    const folderPath = './pdfs/';
    const logoUrl = './logo.png';
    const fileListElement = document.getElementById('file-list');
    const searchInput = document.getElementById('search');

    const logo2Files = [
      'TEHUACAN BRILLANTE LATA SLEEK.pdf',
      'TEHUACAN BRILLANTE NARANJADA.pdf',
      'TEHUACAN BRILLANTE LIMONADA.pdf',
      'Tehuacan Brillante.pdf',
      'Agua de Piedra.pdf'
    ];

    async function loadPdfList() {
      try {
        const res = await fetch('./pdfs/names.txt');
        if (!res.ok) throw new Error('No se pudo cargar la lista de PDFs');
        const text = await res.text();
        // dividir por líneas y filtrar vacías
        pdfFiles = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        renderFiles(pdfFiles);
      } catch (err) {
        console.warn('Fallo al cargar names.txt, usando lista embebida mínima. ' + err.message);
        // Fallback a la lista anterior mínima si existe un fallo
        pdfFiles = ['Agua de Piedra.pdf', 'MONTEVIEJO La Violeta Malbec.pdf'];
        renderFiles(pdfFiles);
      }
    }

    function renderFiles(filteredFiles) {
      fileListElement.innerHTML = '';
      if (!filteredFiles || filteredFiles.length === 0) {
        fileListElement.innerHTML = '<div class="no-results">No se encontraron resultados.</div>';
        return;
      }
      filteredFiles.forEach(file => {
        const div = document.createElement('div');
        div.className = 'file-item';
        const fileTitle = document.createElement('span');
        fileTitle.textContent = file;
        fileTitle.style.fontWeight = '500';
        const logoBtn = document.createElement('button');
        logoBtn.textContent = logo2Files.includes(file) ? 'Descargar Pdf' : 'Descargar con restricciones de alcohol';
        logoBtn.onclick = () => {
          const logoToUse = logo2Files.includes(file) ? './logo2.png' : logoUrl;
          addLogoToPdf(folderPath + file, file, logoToUse);
        };
        div.appendChild(fileTitle);
        div.appendChild(logoBtn);
        fileListElement.appendChild(div);
      });
    }

    function filterFiles(query) {
      const filtered = pdfFiles.filter(file =>
        file.toLowerCase().includes(query.toLowerCase())
      );
      renderFiles(filtered);
    }

    searchInput.addEventListener('input', e => {
      filterFiles(e.target.value);
    });

    // Función para agregar logo a un PDF
    async function addLogoToPdf(pdfUrl, fileName, logoPath = logoUrl) {
      try {
        const existingPdfBytes = await fetch(pdfUrl).then(res => res.arrayBuffer());
        const pngImageBytes = await fetch(logoPath).then(res => res.arrayBuffer());
        const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
        const pngImage = await pdfDoc.embedPng(pngImageBytes);
        const pages = pdfDoc.getPages();
        for (const page of pages) {
          const { width } = page.getSize();
          const logoWidth = width - 60; // margen lateral
          const originalWidth = 2315.4268;
          const originalHeight = 90.8682;
          const logoHeight = (logoWidth / originalWidth) * originalHeight;
          page.drawImage(pngImage, {
            x: 30,
            y: 10,
            width: logoWidth,
            height: logoHeight,
          });
        }
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
      } catch (error) {
        alert('Error al agregar el logo: ' + error.message);
      }
    }

    // Descargar todos los PDFs en un ZIP (inserta logo correspondiente por archivo)
    async function downloadCompleteZip() {
      const filesToZip = Array.from(pdfFiles); // todos los archivos
      const zip = new JSZip();
      // Procesar cada PDF y agregarlo al ZIP
      for (const file of filesToZip) {
        try {
          const existingPdfBytes = await fetch(folderPath + file).then(res => res.arrayBuffer());
          // elegir logo según el archivo
          const logoPath = logo2Files.includes(file) ? './logo2.png' : logoUrl;
          const pngImageBytes = await fetch(logoPath).then(res => res.arrayBuffer());
          const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
          const pngImage = await pdfDoc.embedPng(pngImageBytes);
          const pages = pdfDoc.getPages();
          for (const page of pages) {
            const { width } = page.getSize();
            const logoWidth = width - 60;
            const originalWidth = 2315.4268;
            const originalHeight = 90.8682;
            const logoHeight = (logoWidth / originalWidth) * originalHeight;
            page.drawImage(pngImage, {
              x: 30,
              y: 10,
              width: logoWidth,
              height: logoHeight,
            });
          }
          const pdfBytes = await pdfDoc.save();
          zip.file(file, pdfBytes);
        } catch (error) {
          console.warn('Error procesando ' + file + ': ' + error.message);
        }
      }
      // Generar y descargar el ZIP
      zip.generateAsync({ type: 'blob' }).then(function(content) {
        const zipName = 'PDFs_completos.zip';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = zipName;
        a.click();
      });
    }

    // Función previa que generaba ZIP excluyendo archivos con logo2 (la dejamos disponible si se necesita)
    async function downloadAlcoholRestrictedZip() {
      const filesToZip = pdfFiles.filter(file => !logo2Files.includes(file));
      const zip = new JSZip();
      const logoPath = logoUrl;
      for (const file of filesToZip) {
        try {
          const existingPdfBytes = await fetch(folderPath + file).then(res => res.arrayBuffer());
          const pngImageBytes = await fetch(logoPath).then(res => res.arrayBuffer());
          const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
          const pngImage = await pdfDoc.embedPng(pngImageBytes);
          const pages = pdfDoc.getPages();
          for (const page of pages) {
            const { width } = page.getSize();
            const logoWidth = width - 60;
            const originalWidth = 2315.4268;
            const originalHeight = 90.8682;
            const logoHeight = (logoWidth / originalWidth) * originalHeight;
            page.drawImage(pngImage, {
              x: 30,
              y: 10,
              width: logoWidth,
              height: logoHeight,
            });
          }
          const pdfBytes = await pdfDoc.save();
          zip.file(file, pdfBytes);
        } catch (error) {
          console.warn('Error procesando ' + file + ': ' + error.message);
        }
      }
      zip.generateAsync({ type: 'blob' }).then(function(content) {
        const zipName = 'PDFs_con_restricciones_de_alcohol.zip';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = zipName;
        a.click();
      });
    }

  // Inicializar
  loadPdfList();
  // El botón ahora descarga el ZIP completo
  document.getElementById('download-zip').addEventListener('click', downloadCompleteZip);
    </script>
  </body>
</html>