<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Buscador de PDFs</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      :root{
        --bg:#ffffff; --fg:#111111; --muted:#666666; --card:#f8f8f8; --toggle-bg:#ddd; --knob-bg:#ffffff;
      }
      .dark{
        --bg:#0f1720; --fg:#e6eef6; --muted:#9fb0c3; --card:#12202a; --toggle-bg:#3b82f6; --knob-bg:#ffffff;
      }
      html,body{height:100%}
      body { font-family: Arial, Helvetica, sans-serif; padding: 20px; background:var(--bg); color:var(--fg); }
      input, button { font-family: inherit }
      #search { width: 60%; padding: 8px; margin-bottom: 12px; border:1px solid #ccc; border-radius:4px }
      .file-item { padding: 8px 0; display:flex;align-items:center;justify-content:space-between;background:transparent }
      .file-item span { flex:1 }
  .file-item button { padding:6px 10px; font-size:14px; margin-left:12px }
      .no-results { color: var(--muted) }
      #download-zip { margin-left: 12px }
      #status { color: var(--muted) }
      /* slider visual tweaks */
      #slider { background:var(--toggle-bg) }
      .dark #slider { background:var(--toggle-bg) }
      .dark #knob { background:var(--knob-bg) }
      /* mobile tweaks */
      @media (max-width: 600px) {
        #preview { max-width:260px; max-height:360px; }
        .file-item { gap:8px }
        .file-item button { padding:4px 8px; font-size:13px; }
        #search { width: 100%; }
      }
      /* botón emoji/texto: por defecto (desktop) mostrar texto, ocultar emoji */
      .btn-emoji { display: none; }
      .btn-text { display: inline; }
      button { cursor: pointer; }
      /* en móvil mostrar solo emoji */
      @media (max-width:600px) {
        .btn-text { display: none !important; }
        .btn-emoji { display: inline-block !important; margin-right:4px; }
      }
    </style>
  </head>
  <body>
    <h1>Buscador de PDFs</h1>
    <div style="display:flex;align-items:center;gap:12px;">
      <input id="search" placeholder="Buscar..." />
      <button id="download-zip">Descargar ZIP Completo</button>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;">
        <span id="theme-label">Claro</span>
        <div id="theme-toggle" style="width:44px;height:24px;position:relative;">
          <input type="checkbox" id="theme-checkbox" style="opacity:0;position:absolute;width:1px;height:1px;left:-9999px;" />
          <div id="slider" style="width:44px;height:24px;border-radius:999px;background:var(--toggle-bg);position:relative;transition:background .2s;"></div>
          <div id="knob" style="width:18px;height:18px;border-radius:50%;background:var(--knob-bg);position:absolute;top:3px;left:3px;transition:left .2s,background .2s;box-shadow:0 1px 3px rgba(0,0,0,.3);"></div>
        </div>
      </label>
    </div>
  <div id="status" style="margin-top:8px;color:#333"></div>
  <div id="file-list"></div>
  <!-- contenedor para previsualización flotante -->
  <div id="preview" style="position:fixed;display:none;z-index:9999;max-width:360px;max-height:480px;border-radius:6px;overflow:hidden;box-shadow:0 8px 24px rgba(2,6,23,.6);background:#fff"></div>

    <script>
    // Cargar lista de PDFs desde pdfs/names.txt para mantener sincronización con la carpeta
    let pdfFiles = [];
    const folderPath = './pdfs/';
    const logoUrl = './logo.png';
    const fileListElement = document.getElementById('file-list');
    const searchInput = document.getElementById('search');

    // Mostrar mensajes simples en la UI
    function setStatus(msg) {
      const el = document.getElementById('status');
      if (el) el.textContent = msg;
      else console.log('STATUS: ' + msg);
    }

    const logo2Files = [
      'TEHUACAN BRILLANTE LATA SLEEK.pdf',
      'TEHUACAN BRILLANTE NARANJADA.pdf',
      'TEHUACAN BRILLANTE LIMONADA.pdf',
      'Tehuacan Brillante.pdf',
      'Agua de Piedra.pdf'
    ];

    async function loadPdfList() {
      try {
        setStatus('Cargando lista de PDFs...');
        const res = await fetch('./pdfs/names.txt');
        if (!res.ok) throw new Error('No se pudo cargar la lista de PDFs');
        const text = await res.text();
        // dividir por líneas y filtrar vacías
        pdfFiles = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        renderFiles(pdfFiles);
        setStatus('Lista cargada (' + pdfFiles.length + ' archivos)');
      } catch (err) {
        console.warn('Fallo al cargar names.txt, usando lista embebida mínima. ' + err.message);
        // Fallback a la lista anterior mínima si existe un fallo
        pdfFiles = ['Agua de Piedra.pdf', 'MONTEVIEJO La Violeta Malbec.pdf'];
        renderFiles(pdfFiles);
        setStatus('Usando fallback: names.txt no disponible');
      }
    }

    function renderFiles(filteredFiles) {
      fileListElement.innerHTML = '';
      if (!filteredFiles || filteredFiles.length === 0) {
        fileListElement.innerHTML = '<div class="no-results">No se encontraron resultados.</div>';
        return;
      }
      filteredFiles.forEach(file => {
        const div = document.createElement('div');
        div.className = 'file-item';
        const fileTitle = document.createElement('span');
          fileTitle.textContent = file;
          fileTitle.className = 'file-title';
          // mostrar previsualizador al pasar el mouse (desktop)
          fileTitle.addEventListener('mouseenter', (ev) => showPreview(file, ev));
          fileTitle.addEventListener('mouseleave', () => hidePreview());
          // en móvil/táctil abrir con click/tap (inmediato)
          fileTitle.addEventListener('click', (ev) => {
            if (window.innerWidth <= 600) {
              ev.stopPropagation();
              showPreview(file, ev, true);
            }
          });
        fileTitle.style.fontWeight = '500';
          const logoBtn = document.createElement('button');
          // crear spans: uno para emoji (visible en móvil) y otro para texto (visible en desktop)
          const emojiSpan = document.createElement('span');
          emojiSpan.className = 'btn-emoji';
          emojiSpan.textContent = '⬇️';
          const textSpan = document.createElement('span');
          textSpan.className = 'btn-text';
          textSpan.textContent = logo2Files.includes(file) ? 'Descargar Pdf' : 'Descargar con restricciones de alcohol';
          logoBtn.appendChild(emojiSpan);
          logoBtn.appendChild(textSpan);
          logoBtn.onclick = (ev) => {
            // evitar que el click del botón abra el preview en móvil
            ev.stopPropagation();
            const logoToUse = logo2Files.includes(file) ? './logo2.png' : logoUrl;
            addLogoToPdf(folderPath + file, file, logoToUse);
          };
        div.appendChild(fileTitle);
        div.appendChild(logoBtn);
        fileListElement.appendChild(div);
      });
    }

    function filterFiles(query) {
      const filtered = pdfFiles.filter(file =>
        file.toLowerCase().includes(query.toLowerCase())
      );
      renderFiles(filtered);
    }

    searchInput.addEventListener('input', e => {
      filterFiles(e.target.value);
    });

    // Función para agregar logo a un PDF
    async function addLogoToPdf(pdfUrl, fileName, logoPath = logoUrl) {
      try {
        setStatus('Procesando ' + fileName + '...');
    const existingPdfBytes = await fetch(folderPath + encodeURIComponent(fileName)).then(res => res.arrayBuffer());
        const pngImageBytes = await fetch(logoPath).then(res => res.arrayBuffer());
        const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
        const pngImage = await pdfDoc.embedPng(pngImageBytes);
        const pages = pdfDoc.getPages();
        for (const page of pages) {
          const { width } = page.getSize();
          const logoWidth = width - 60; // margen lateral
          const originalWidth = 2315.4268;
          const originalHeight = 90.8682;
          const logoHeight = (logoWidth / originalWidth) * originalHeight;
          page.drawImage(pngImage, {
            x: 30,
            y: 10,
            width: logoWidth,
            height: logoHeight,
          });
        }
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        setStatus('Descarga completada: ' + fileName);
      } catch (error) {
        console.error(error);
        setStatus('Error al procesar ' + fileName + ': ' + error.message);
        alert('Error al agregar el logo: ' + error.message);
      }
    }

    // Previsualizador PDF (carga al hover)
    let previewTimeout = null;
    let hidePreviewTimeout = null;
    function showPreview(file, ev, immediate = false) {
      // cancelar cualquier hide pendiente y debounce de carga
      clearTimeout(hidePreviewTimeout);
      clearTimeout(previewTimeout);
      const delay = immediate ? 0 : 180;
      previewTimeout = setTimeout(() => {
        const preview = document.getElementById('preview');
        if (!preview) return;
        // calcular tamaño en base al ancho del texto hovered (ev.target)
        const pad = 12;
        const vw = window.innerWidth;
        const targetRect = ev.target.getBoundingClientRect ? ev.target.getBoundingClientRect() : { width: 200, left: ev.clientX, top: ev.clientY };
        // tamaño base: un poco más ancho que el texto, con límites
        let previewWidth = Math.min(360, Math.max(180, Math.round(targetRect.width + 20)));
        let previewHeight = Math.min(480, Math.round(previewWidth * 1.2));
        // en pantallas pequeñas reducir más
        if (vw <= 600) {
          previewWidth = Math.min(260, vw - 24);
          previewHeight = Math.min(360, Math.round(previewWidth * 1.2));
        }
        preview.style.width = previewWidth + 'px';
        preview.style.height = previewHeight + 'px';

        // posicionar y evitar salir de la ventana; posicion relativo al texto (no al bloque completo)
        let x = Math.round(targetRect.right + pad);
        let y = Math.round(targetRect.top + pad);
        const vh = window.innerHeight;
        if (x + previewWidth + pad > vw) x = Math.round(targetRect.left - previewWidth - pad);
        if (x < pad) x = pad;
        if (y + previewHeight + pad > vh) y = Math.max(pad, Math.round(targetRect.bottom - previewHeight - pad));

        preview.style.left = x + 'px';
        preview.style.top = y + 'px';
        preview.style.display = 'block';

        // limpiar contenido previo
        preview.innerHTML = '';
        const iframe = document.createElement('iframe');
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = '0';
        iframe.src = folderPath + encodeURIComponent(file) + '#view=FitH';
        preview.appendChild(iframe);
      }, delay);
    }

    // cerrar preview si el usuario hace click fuera (útil en móvil)
    document.addEventListener('click', (e) => {
      const preview = document.getElementById('preview');
      if (!preview) return;
      if (preview.style.display === 'block') {
        if (!preview.contains(e.target) && !e.target.classList.contains('file-title')) {
          hidePreview(true);
        }
      }
    });

    function hidePreview(immediate = false) {
      // si immediate true, ocultar ya; si no, esperar un pequeño timeout para permitir entrar al panel
      clearTimeout(previewTimeout);
      clearTimeout(hidePreviewTimeout);
      const preview = document.getElementById('preview');
      if (!preview) return;
      if (immediate) {
        preview.style.display = 'none';
        preview.innerHTML = '';
        return;
      }
      hidePreviewTimeout = setTimeout(() => {
        preview.style.display = 'none';
        preview.innerHTML = '';
      }, 260);
    }

    // permitir que al entrar el ratón en el preview no se oculte
    (function(){
      const preview = document.getElementById('preview');
      if (!preview) return;
      preview.addEventListener('mouseenter', () => {
        clearTimeout(hidePreviewTimeout);
      });
      preview.addEventListener('mouseleave', () => hidePreview());
    })();

    // Descargar todos los PDFs en un ZIP (inserta logo correspondiente por archivo)
    async function downloadCompleteZip() {
      const downloadBtn = document.getElementById('download-zip');
      downloadBtn.disabled = true;
      setStatus('Creando ZIP con ' + pdfFiles.length + ' archivos... (esto puede tardar)');
      const filesToZip = Array.from(pdfFiles); // todos los archivos
      const zip = new JSZip();
      // Procesar cada PDF y agregarlo al ZIP
      for (const file of filesToZip) {
        try {
          setStatus('Procesando: ' + file + ' (' + (filesToZip.indexOf(file) + 1) + '/' + filesToZip.length + ')');
            const existingPdfBytes = await fetch(folderPath + encodeURIComponent(file)).then(res => res.arrayBuffer());
          // elegir logo según el archivo
          const logoPath = logo2Files.includes(file) ? './logo2.png' : logoUrl;
          const pngImageBytes = await fetch(logoPath).then(res => res.arrayBuffer());
          const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
          const pngImage = await pdfDoc.embedPng(pngImageBytes);
          const pages = pdfDoc.getPages();
          for (const page of pages) {
            const { width } = page.getSize();
            const logoWidth = width - 60;
            const originalWidth = 2315.4268;
            const originalHeight = 90.8682;
            const logoHeight = (logoWidth / originalWidth) * originalHeight;
            page.drawImage(pngImage, {
              x: 30,
              y: 10,
              width: logoWidth,
              height: logoHeight,
            });
          }
          const pdfBytes = await pdfDoc.save();
          zip.file(file, pdfBytes);
        } catch (error) {
          console.warn('Error procesando ' + file + ': ' + error.message);
          console.error(error);
        }
      }
      // Generar y descargar el ZIP
      zip.generateAsync({ type: 'blob' }).then(function(content) {
        const zipName = 'PDFs_completos.zip';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = zipName;
        a.click();
        setStatus('ZIP creado: ' + zipName);
        downloadBtn.disabled = false;
      }).catch(err => {
        console.error(err);
        setStatus('Error al generar ZIP: ' + err.message);
        downloadBtn.disabled = false;
      });
    }

    // Función previa que generaba ZIP excluyendo archivos con logo2 (la dejamos disponible si se necesita)
    async function downloadAlcoholRestrictedZip() {
      const filesToZip = pdfFiles.filter(file => !logo2Files.includes(file));
      const zip = new JSZip();
      const logoPath = logoUrl;
      for (const file of filesToZip) {
        try {
            const existingPdfBytes = await fetch(folderPath + encodeURIComponent(file)).then(res => res.arrayBuffer());
          const pngImageBytes = await fetch(logoPath).then(res => res.arrayBuffer());
          const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
          const pngImage = await pdfDoc.embedPng(pngImageBytes);
          const pages = pdfDoc.getPages();
          for (const page of pages) {
            const { width } = page.getSize();
            const logoWidth = width - 60;
            const originalWidth = 2315.4268;
            const originalHeight = 90.8682;
            const logoHeight = (logoWidth / originalWidth) * originalHeight;
            page.drawImage(pngImage, {
              x: 30,
              y: 10,
              width: logoWidth,
              height: logoHeight,
            });
          }
          const pdfBytes = await pdfDoc.save();
          zip.file(file, pdfBytes);
        } catch (error) {
          console.warn('Error procesando ' + file + ': ' + error.message);
        }
      }
      zip.generateAsync({ type: 'blob' }).then(function(content) {
        const zipName = 'PDFs_con_restricciones_de_alcohol.zip';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = zipName;
        a.click();
      });
    }

  // Inicializar
  // Tema: aplicar preferencia guardada
  (function(){
    const stored = localStorage.getItem('site-theme');
    if(stored === 'dark') document.documentElement.classList.add('dark');
  })();

  function updateThemeUI(){
    const isDark = document.documentElement.classList.contains('dark');
    const checkbox = document.getElementById('theme-checkbox');
    const label = document.getElementById('theme-label');
    const knob = document.getElementById('knob');
    if(checkbox) checkbox.checked = !!isDark;
    if(label) label.textContent = isDark ? 'Oscuro' : 'Claro';
    if(knob) knob.style.left = isDark ? '23px' : '3px';
  }

  // Conectar toggle
  const toggleEl = document.getElementById('theme-toggle');
  if(toggleEl) toggleEl.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('site-theme', isDark ? 'dark' : 'light');
    updateThemeUI();
  });

  updateThemeUI();

  loadPdfList();
    // Polling para mantener la lista sincronizada sin pasos manuales
    (function(){
      let lastNamesTxt = null;
      const pollInterval = 10000; // ms
      async function pollNames() {
        try {
          const res = await fetch('./pdfs/names.txt', { cache: 'no-store' });
          if (!res.ok) return;
          const text = await res.text();
          if (lastNamesTxt === null) {
            lastNamesTxt = text;
          } else if (text !== lastNamesTxt) {
            // cambiar detectado -> recargar lista y actualizar UI
            lastNamesTxt = text;
            pdfFiles = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            renderFiles(pdfFiles);
            setStatus('Lista actualizada automáticamente (' + pdfFiles.length + ' archivos)');
          }
        } catch (err) {
          console.warn('Error en polling names.txt:', err.message);
        }
      }
      // empezar polling: primer chequeo tras intervalo para evitar doble fetch inmediato
      setTimeout(() => { pollNames(); setInterval(pollNames, pollInterval); }, pollInterval);
    })();
  // El botón ahora descarga el ZIP completo
  document.getElementById('download-zip').addEventListener('click', downloadCompleteZip);
    </script>
  </body>
</html>